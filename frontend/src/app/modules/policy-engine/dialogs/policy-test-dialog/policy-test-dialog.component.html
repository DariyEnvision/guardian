
<div class="dialog-header">
    <div class="header-container">
        <div class="header-text">Policy Tests</div>
        <div *ngIf="policy" class="header-item">{{policy.name}}</div>
    </div>
    <div class="header-icon" (click)="onClose()">
        <svg-icon src="/assets/images/icons/close.svg" svgClass="close-icon-color"></svg-icon>
    </div>
</div>
<div class="dialog-body">
    <div class="context">
        <div *ngIf="loading" class="loading">
            <div class="preloader-image preloader-image-l-size"></div>
        </div>

        <div *ngIf="tests && tests.length" class="dialog-grid-container">
            <div class="dialog-grid-header">
                <div class="col-44"></div>
                <div class="col-200 col-text">Start Date</div>
                <div class="col-auto col-text">Duration</div>
                <div class="col-150 col-text">Status</div>
                <div class="col-150">Results</div>
                <div class="col-150">Operations</div>
                <div class="col-64"></div>
            </div>
            <div class="dialog-grid-body">
                <ng-container *ngFor="let item of tests" >   
                    <div class="dialog-grid-row" (click)="expand(item)" [attr.expand]="getExpand(item)">
                        <div class="col-44">
                            <svg-icon
                                *ngIf="item.result || item.error"
                                class="icon-btn expand-icon"
                                src="/assets/images/icons/right-arrow.svg"
                                svgClass="disabled-color">
                            </svg-icon>
                        </div>
                        <div class="col-200 col-text">{{getDate(item.date)}}</div>
                        <div class="col-auto col-text">{{getTime(item.duration)}}</div>
                        <div class="col-150 col-button">
                            <div class="status-label {{item.status}}-status">{{item.status}}</div>
                        </div>
                        <div class="col-150">
                            <div *ngIf="item.status==='Running'" class="results">
                                <div class="progress-bar">
                                    <div class="progress-bar-value" [style.width.%]="item.progress"></div>
                                </div>
                                <div class="progress-label"> {{getProgress(item.progress)}}</div>
                            </div>
                            <div *ngIf="item.status === 'Success' || item.status === 'Failure'" class="results">
                                <ng-container *ngIf="item.result || item.error">
                                    <div class="static-bar">
                                        <div class="static-bar-value" [style.width.%]="item.result?.total"></div>
                                    </div>
                                    <div class="progress-label results-total"
                                        [attr.total-value]="item.result?.total"> {{getProgress(item.result?.total)}}</div>
                                </ng-container>
                                <!-- <div *ngIf="item.result || item.error" class="results-total" [attr.total-value]="item.result?.total">
                                    {{getProgress(item.result?.total)}}
                                </div> -->
                            </div>
                        </div>
                        <div class="col-150 col-button">
                            <ng-container *ngIf="status === 'DRY-RUN' || status === 'DEMO'">
                                <button 
                                    *ngIf="item.status === 'New'"
                                    (click)="runTest(item, $event)"
                                    class="button action-button run-button"
                                    label="Run"
                                    pButton></button>
                                <button 
                                    *ngIf="item.status === 'Success' || item.status === 'Failure'"
                                    (click)="runTest(item, $event)"
                                    class="button action-button re-run-button"
                                    label="Re-Run"
                                    pButton></button>
                                <button 
                                    *ngIf="item.status === 'Running'"
                                    (click)="stopTest(item, $event)"
                                    class="button action-button stop-button"
                                    label="Stop"
                                    pButton></button>
                            </ng-container>
                        </div>
                        <div class="col-64 col-button">
                            <div class="small-btn">
                                <svg-icon
                                    (click)="deleteTest(item, $event)"
                                    class="icon-btn"
                                    src="/assets/images/icons/delete.svg"
                                    svgClass="delete-color">
                                </svg-icon>
                            </div>
                        </div>
                    </div>
                    <div class="dialog-grid-expand-row" [attr.expand]="getExpand(item)">
                        <ng-template 
                            *ngIf="item.result || item.error"
                            [ngTemplateOutlet]="detailsTemplate"
                            [ngTemplateOutletContext]="getResults(item)"></ng-template>
                    </div>
                </ng-container>
            </div>
        </div> 


    </div>
</div>
<!-- <div class="dialog-footer">
    <div class="action-buttons">
        <div class="cancel-button">
            <button (click)="onClose()" class="button secondary" label="Cancel" pButton></button>
        </div>
        <div>
            <button (click)="onCompare()" 
                class="button" 
                pButton>
                <svg-icon
                    class="icon2-btn"
                    src="/assets/images/icons/compare.svg"
                    [svgClass]="'disabled-icon-color'">
                </svg-icon>
            </button>
        </div>
    </div>
</div> -->

<ng-template #detailsTemplate 
    let-runStep="runStep" 
    let-compareStep="compareStep"
>
    <div class="results-details">
        <div class="results-step">
            <div class="results-step-header">
                <div class="results-step-expand">
                    <svg-icon
                        *ngIf="runStep.status !== 'Skipped'"
                        class="icon-btn expand-icon"
                        src="/assets/images/icons/right-arrow.svg"
                        svgClass="disabled-color">
                    </svg-icon>
                </div>
                <div class="results-step-status">
                    <svg-icon
                        *ngIf="runStep.status === 'Skipped'"
                        class="icon-btn"
                        src="/assets/images/icons/skip.svg"
                        svgClass="disabled-color">
                    </svg-icon>
                    <svg-icon
                        *ngIf="runStep.status === 'Success'"
                        class="icon-btn"
                        src="/assets/images/icons/check.svg"
                        svgClass="success-color">
                    </svg-icon>
                    <svg-icon
                        *ngIf="runStep.status === 'Failure'"
                        class="icon-btn"
                        src="/assets/images/icons/close-2.svg"
                        svgClass="delete-color">
                    </svg-icon>
                </div>
                <div class="results-step-name">Run Test</div>
            </div>
            <div class="results-step-body" *ngIf="runStep.error">
                <div class="text-error">{{runStep.error}}</div>
            </div>
            <div class="results-step-body" *ngIf="!runStep.error">
                <div class="text-success">Finished</div>
            </div>
        </div>
        <div class="results-step">
            <div class="results-step-header">
                <div class="results-step-expand">
                    <svg-icon
                        *ngIf="compareStep.status !== 'Skipped'"
                        class="icon-btn expand-icon"
                        src="/assets/images/icons/right-arrow.svg"
                        svgClass="disabled-color">
                    </svg-icon>
                </div>
                <div class="results-step-status">
                    <svg-icon
                        *ngIf="compareStep.status === 'Skipped'"
                        class="icon-btn"
                        src="/assets/images/icons/skip.svg"
                        svgClass="disabled-color">
                    </svg-icon>
                    <svg-icon
                        *ngIf="compareStep.status === 'Success'"
                        class="icon-btn"
                        src="/assets/images/icons/check.svg"
                        svgClass="success-color">
                    </svg-icon>
                    <svg-icon
                        *ngIf="compareStep.status === 'Failure'"
                        class="icon-btn"
                        src="/assets/images/icons/close-2.svg"
                        svgClass="delete-color">
                    </svg-icon>
                </div>
                <div class="results-step-name">Compare Results</div>
            </div>
            <div class="results-step-body" *ngIf="compareStep.report">
                <ng-template 
                    [ngTemplateOutlet]="compareDocumentTemplate"
                    [ngTemplateOutletContext]="compareStep.report"></ng-template>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #compareDocumentTemplate 
    let-info="info" 
    let-results="documents"
    let-total="total"
>
    <div class="compare-details">

        <div class="compare-col">
            <div class="compare-header">
                Common
            </div>

            <div class="compare-info">
                <div class="compare-info-header">Created documents:</div>
                <div>{{info?.documents}}</div>
            </div>
            <div class="compare-info">
                <div class="compare-info-header">Minted tokens:</div>
                <div>{{info?.tokens}}</div>
            </div>
            <div class="compare-info">
                <div class="compare-info-header">Total rate:</div>
                <div class="rate-color" [attr.rate-color]="total">{{total}}%</div>
            </div>
        </div>
        <div class="compare-col">
            <div class="compare-header">
                Documents
            </div>

            <div class="compare-body">
                <div *ngFor="let item of results; let i=index" class="compare-item">
                    <div class="document-type">{{item.type}}</div>
                    <div class="document-schema">
                        <a (click)="openDocument(item)">{{item.schema}}</a>
                    </div>
                    <div class="document-rate rate-color" [attr.rate-color]="item.rate">{{item.rate}}</div>
                </div>
            </div>
        </div>
        <div class="more-details">
            <div class="link-btn" (click)="onDetails()">Show more details</div>
        </div>
    </div>
</ng-template>